---
title: "Working with Primary data"
subtitle: "`cori.data.fcc`:: an example of data as code"
author: "Olivier Leroy"
date: "October 20 2024"
institute: "Center On Rural Innovation"
fontsize: 20pt
favicon: assets/images/Logo-Mark_Black.png
format:
  revealjs: 
    theme: src/custom_cori.scss
    logo: img/CORI_Logo.png
    css: assets/fonts.css
    footnotes-hover:: true
from: markdown+emoji
editor: visual
---


## GOALS & PLAN

#### My goals: 

1. Convince you that you should use code to work with primary data

2. Package this code will make everyone live easier

<p>&nbsp;</p>

#### Plan

* Presentation: Me & CORI 

* FCC's Data

* `cori.data.fcc`: primary data as code

* Examples of uses cases

* Discussions
 
## :wave: Hi, I am Olivier 

- Socials: [LinkedIn](https://www.linkedin.com/in/olivier-leroy-r/) | [Mastodon](https://fosstodon.org/@defuneste) | [Personal Website](https://branchtwigleaf.com/about.html) 

![Source: [Harvard Business Review](https://hbr.org/2012/10/data-scientist-the-sexiest-job-of-the-21st-century)](img/hbrsexiestjob.png){width=800} 

- Data Engineer and working with primary data: "messy, unstructured data" is upon us

## Slides are online: 

Realized in [Quarto](https://quarto.org/) (Reavealjs) hosted/deployed in [GitHub](https://github.com/ruralinnovation/conf_URISA_2023), Running R and cori.data.fcc
<br />[https://ruralinnovation.github.io/prez_auber_2024/](https://ruralinnovation.github.io/prez_auber_2024/#/title-slide)

![](img/qr.svg){height="300" fig-align="center"}


## Center On Rural Innovation ([CORI](https://ruralinnovation.us/))

*Advancing economic prosperity in rural America through the creation of inclusive tech economy ecosystem that support scalable entrepreneurship and tech job creation*
<img style="float:right; position: relative; top: 0px; margin: 2.5% 10%; width: 50vw; height: calc(50vw / 1.816);max-height:  none !important;" src="img/cori_triangle.png" data-lazy-loaded="">
<!--
![](img/cori_triangle.png){fig-align="center"}
-->

1. Broadband Infrastucture is an important part of it

2. Rural data: Need to go back to primary data  

# FCC's Data

## Federal Communications Commission ([FCC](https://www.fcc.gov/)) 

:::: {.columns} 

::: {.column width="30%"}

![](img/fcc-seal-rgb-2020.svg)

:::

::: {.column width="70%"}

- Agency in charge of regulating "everything" communications

- Lot of useful datasets!

- Their data landscape is evolving fast (now they have a [platform](https://opendata.fcc.gov/)!)

**Challenge**: how to work with constant change upstream?
:::

::::


## Federal Communications Commission ([FCC](https://www.fcc.gov/))  


:::: {.columns}

::: {.column width="50%"}


|                      | [Form 477](https://www.fcc.gov/economics-analytics/industry-analysis-division/form-477-resources)             | [National Broadband Map](https://broadbandmap.fcc.gov/home)                                                                                                                                                                          |
|-------------------------|------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| US Census Boundaries | 2010             | 2020                                                                                                                                                                                                                                 |
| Type of recording    | self declarative | self declarative                                                                                                                                                                                                                     |
| Granularity          | Census blocks     | [Locations](https://broadbandmap.fcc.gov/location-summary/fixed?version=dec2022&location_id=1350199199&addr1=390+MORGAN+ST&addr2=OBERLIN%2C+OH+44074&zoom=15.00&vlon=-82.231744&vlat=41.287448&br=r&speed=25_3&tech=1_2_3_4_5_6_7_8) |
| Services             | Mobile/**Fixed** | Mobile/**Fixed**                                                                                                                                                                                                                     |
|Timeframe | 2014-2021 | 2022 - *Ongoing*                                                                                                                                                                                                                     |
| Releases | twice a year | twice a year[^version]                                                                                                                                                                                                               |
| Size | 400MB/year | 22GB/year                                                                                                                                                                                                                            |

[^version]: One release can have multiple versions


:::

::: {.column width="50%"}


- 2 **voluminous** datasets are providing an overview of broadband access since 2014

- Multiples files (csv), tabular format and no "road safety barriers"

**Challenge**: Build an infrastructure that allows you to **capitalize** on your work?
:::

::::


## FCC data in our apps and analysis work

Broadband data is used extensively in our work: 

- Provide critical support to secure funding, 

- Develop infrastructure, 

- Implement the programs needed to unlock the potential of rural America.

<p style="max-height: 50px">
Along with our ongoing broadband consulting and technical assistance work, we released
two public-facing apps that rely on FCC primary data:
</p>

- 2023: [Broadband Climate Risk Mitigation Tool](https://broadband-risk.ruralinnovation.us/)

- 2024: [Rural Broadband Mapping Tool](https://rural-broadband-map.ruralinnovation.us/)

<!-- also included in ERC tools should I mention it? -->

<p style="max-height: 50px">
We are also using it on our report and research projects
</p>

- [Beyond connectivity: The role of broadband in rural economic growth and resilience](https://ruralinnovation.us/resources/reports/report-the-role-of-broadband-in-rural-economic-growth-and-resilience/)

- [The equity of economic opportunity in rural America](https://ruralinnovation.us/blog/equity-economic-opportunity-rural-america/)

- Multiple projects at different times, multiple tables


## Our Previous data processing pattern:

```{mermaid}
%%{init: {'theme': 'base', 'themeVariables': { 'fontSize': '20px', 'fontFamily': 'Bitter'}}}%%
flowchart LR
    A1[FCC Website] --> B1[Server]
    A2[TIGER Census block] --> C2
    subgraph Ingestion
    direction TB
    B1--> B2[Data Wrangling]
    B2--> B3[Populate source DB]
    end
    subgraph Transform
    direction TB
    C1[Remove Sat.]--> C2[Count Services]
    C2 --> C3[Blocks DB]
    end
    subgraph Serving
    direction TB
    D1[Prod. Server] --> D2[Analytic Tables]
    end
    Ingestion --> Transform
    C3 --> D1
    D1--> E1[Tools]
    D2--> E1
    D2 --> E4[Data team <BR> Broadband team]
    style Ingestion fill:#fff
    style Transform fill:#fff
    style Serving fill:#fff
```

- Classic ELT (Extract Load Transform):
  - ->  transformation step had to happen in the database (slow or $$$)

- Any change in the business/research needs (i.e., "We need ISP footprints" / "We should exclude locations with bad latency"):
  - ->  required another cycle to ingest/load/transform

> You can quote me.... "My manager regularly asks for quick turn deliveries".... "He's bullies the team with short delivery times"


## Manuel ELT v.s. ...

:::: {.columns}

::: {.column width="50%"}

![](img/manual_fcc.mov)


:::

::: {.column width="50%"}

* :repeat: Repeat for every State  (56)
* :repeat: Repeat for every version  (??)
* :red_circle: Error prone (500 hundred clicks)

:::

::::


## ... Code Automated ...

:::: {.columns}

::: {.column width="50%"}

```{bash}
#| eval: false
#| echo: true

# [...] 
# Download all FCC data needed
all : dirs dl_file list_file

include config.mk

## dirs:	Create specific dirs to download data
dirs : config.mk
	@pwd
	@mkdir -p $(DATA_PATH)
	echo "create $(DATA_PATH)"

## dl_file:	Create a list of files availiable, download them
dl_file : $(CSV_SRC) get_csv_dl.R
	Rscript get_csv_dl.R $(CSV_SRC)
	Rscript list_file_dl.R $(DATA_PATH) $(CSV_SRC)
.PHONY : dl_file

## list_file: Create a list of downloaded file
list_file : list_file_dl.R $(CSV_SRC)
	Rscript report_dl.R $(DATA_PATH) 
.PHONY : list_file

# [...]
```

:::

::: {.column width="50%"}

- "old" GNU make: bash, R codes, SQL

- 227 commits

- 267 files

- New project / New spec 

  - **challenge**: copy/pasting and maintaining X **similar** code sources 

:::

::::

## ... Code Packaged

:::: {.columns}

::: {.column width="50%"}

::: {.panel-tabset}

### Visual
![](img/dl_nbm_smaller.mov)

### Code

```{r}
#| label: example_dl_nbm
#| eval: false
#| echo: true
library(cori.data.fcc)

dir <- "data_swamp/nbm/"

get_nbm_release()

nbm_data <- get_nbm_available()

system(sprintf("mkdir -p %s", dir))

dl_nbm(
  path_to_dl = "data_swamp/nbm",
  release_date = "June 30, 2023",
  data_type = "Fixed Broadband",
  data_category = "Nationwide",
)
# part to check if dl was successful 
num_files <- get_nbm_available() |>
  dplyr::filter(release == "June 30, 2023" &
                data_type == "Fixed Broadband" &
                data_category == "Nationwide") |>
  nrow()

files_dl <- length(list.files(dir,
                              pattern = "*.zip"))

identical(num_files, files_dl)
# TRUE

```

:::

:::

::: {.column width="50%"}


- Reduce errors 

- Complexity is in **one** place and **abstracted** 

- Provide a timestamp: solve the "multiple tables" issue 

:::

::::


# cori.data.fcc

## What can it do? 

1. Download data from FCC

2. Download raw data from CORI (NBM / Form 477)

3. Download tranformed data (NBM) from CORI

4. Guide you!

## New technologies:

<p style="float: left">
DuckDB ([Parquet](https://parquet.apache.org/) / [Arrow](https://arrow.apache.org/) / [OLAP](https://en.wikipedia.org/wiki/Online_analytical_processing)) and S3 (Simple Storage Service of AWS)
<img style="float:right; position: relative; top: 0px; margin-right: 30%;" src="img/DuckDB_logo.svg" data-lazy-loaded="">
</p>

- Simplify architecture: 

  * Compute: PostgreSQL (RDS) -> DuckDB 

  * Storage: PostgreSQL (RDS) -> S3 (Range HTTP, storage with nice access)

- Parquet and interoperability: 

  * Computer language change, file format also but way slowly 

  * File format is more agnostic

- Results:

  * Solved the lack of **reactivity**: working with primary data does not need to be slow!  

  * Added benefits: **lower cost**, less contraints on permissions -> share it!

## Why sharing it?

1. Sharing it with "ourself" and the broadband community 

2. Facilitate the access to primary data to researchers, regional economists:  one of CORI's goal is to provide rural community with good internet.

- Open source is :

  * Way to share: Everyone can use it

  * Way to publish: Everyone can read the code and contribute

  * A place were we can exchange in a constructive way 

  
## Packaging code: Documentation make easier
  
- What does this function do? ->  [References](https://ruralinnovation.github.io/cori.data.fcc/reference/index.html) / `?get_nbm_block`

- How can I integrate those functions in my workflow? [Vignettes/Uses cases](https://ruralinnovation.github.io/cori.data.fcc/articles/Check_and_download_NBM_data.html)

- A doubt on how the data was processed: [Articles](https://ruralinnovation.github.io/cori.data.fcc/articles/NBM.html) and [`data-raw/`](https://github.com/ruralinnovation/cori.data.fcc/tree/main/data-raw)

- Versions / updates with a [Changelog](https://ruralinnovation.github.io/cori.data.fcc/news/index.html) 

<br>

> weâ€™ve talked about how packages can act like team members such as the IT Guy, Analyst, Tech Lead, or Project Manager.[^emily]

>  [...] developed packages are [...] extra expert team members.[^dataanalysisreuse]

[^emily]: [https://www.emilyriederer.com/post/team-of-packages/#collaboration](https://www.emilyriederer.com/post/team-of-packages/#collaboration)

[^dataanalysisreuse]: [https://milesmcbain.xyz/posts/data-analysis-reuse/](https://milesmcbain.xyz/posts/data-analysis-reuse/)

## Packaging code: Data as code
 
::: {.panel-tabset}

### Code

```{r}
#| echo: true
#| eval: false
fcc_dict <- cori.data.fcc::get_fcc_dictionary()
fcc_dict[grep("frn", fcc_dict$var_name),
         c("dataset", "var_name", "var_example")]
```

### Result

```{r}
#| echo: false
fcc_dict <- cori.data.fcc::get_fcc_dictionary()
fcc_dict[grep("frn", fcc_dict$var_name),
         c("dataset", "var_name", "var_example")]
```

:::

- Better documentation: `get_fcc_dictionary`

- Website to share it (benefits from the language ecosystem)

- Easy to distribute: GitHub / built-in functions -> Next slide

- Tests! 

- **Capitalize on it**! 

  * New project that is requiring [FCC staff block estimates](https://www.fcc.gov/staff-block-estimates): it can be added 


# Examples of uses cases

## How to get it: 

The source code is hosted on [GitHub](https://github.com/ruralinnovation/cori.data.fcc) (Version control) it has a website: [https://ruralinnovation.github.io/cori.data.fcc/index.html](https://ruralinnovation.github.io/cori.data.fcc/index.html) 

You need the R packages [{remotes}](https://remotes.r-lib.org/).

```{r}
#| eval: false
#| label: install-package
#| echo: true
 
install.packages("remotes")
remotes::install_github("ruralinnovation/cori.data.fcc")
```

:construction: Check the version you have and see what new versions are offering :construction:
```{r}
#| label: version-package
#| echo: true
packageVersion("cori.data.fcc")
```

## First Example: Block covered BEAD like

Place holder for Camdem blog post

## Second Example: ISP networks

- `nbm_block` dataset is at the Census Block level (one row = one Census Block)

- A column with a list of FRN in every block:

`# [1] "0002930980" "0002946986" "0003757341" "0016098931" "0018506568" "0020449831" "0025646373"`

- Use of `fcc_providers` : `"0002930980"` ->  `"W A T C H TV Company"`

#### What are the ISP that share commun blocks (or not) in Ohio?

## Second Example: ISP networks

::: {.panel-tabset}

### Visual

```{r}
#| echo: FALSE
#| eval: TRUE
library(igraph)
library(crosstalk);library(DT);library(threejs)


oh_graph <- readRDS("data//oh_graph.rds")

draw_me_a_graph <- function(x, ...) {
  threejs::graphjs(x,
          vertex.label = V(x)$provider_name, 
          vertex.color = rep(2, vcount(x)),
          vertex.size = .5, 
          edge.color = "black",
          edge.width = 2, ...)
}

sd = SharedData$new(data.frame(provider_name = V(oh_graph)$provider_name))
bscols(widths = c(4, 8),
       list(
         datatable(sd, rownames=FALSE),
         datatable(sd, rownames=FALSE)
       ),
       draw_me_a_graph(oh_graph, brush=TRUE, crosstalk=sd)
)

```


### Code 

```{r}
#| echo: TRUE
#| eval: FALSE
#| code-line-numbers: "8,36"
library(tigris);library(cori.data.fcc);library(igraph);library(dplyr) 
library(crosstalk);library(DT);library(threejs)

oh<- tigris::counties(state = "39") # tigris is a great example of data as code

talk_to_me <- function(x) {
    message(sprintf("Love Ohio: %s", x))
    cori.data.fcc::get_nbm_bl(x)
}
oh_nbm <- lapply(oh$GEOID, talk_to_me) |> dplyr::bind_rows()

oh2_nbm <- oh_nbm[!is.na(oh_nbm$combo_frn), ]

od_me <- function(x) {
  
  temp <- oh2_nbm[x, "array_frn"][[1]]
  if (length(temp) == 1L)
  {
    return(data.frame(V1 = temp, V2 = NA))
  }
  as.data.frame(t(combn(temp, 2)))
}

od <- lapply(1:nrow(oh2_nbm), od_me) |> dplyr::bind_rows()
od <- od[!is.na(od$V2),]

od$combo <- paste(od$V1, od$V2, sep = " - ")
od$count <- 1

rel <- od |> dplyr::summarize(n = sum(count), .by = combo)
give_me_from <- function(x) unlist(strsplit(x, " - "))[1]
give_me_to <- function(x) unlist(strsplit(x, " - "))[2]
rel$from <- sapply(rel$combo , give_me_from)
rel$to <- sapply(rel$combo, give_me_to)

fcc_slim <- cori.data.fcc::fcc_provider[, c("frn", "provider_name")]
frn <- data.frame( frn = unique(c(rel$from, rel$to)))
frn <- merge(frn, fcc_slim, by.x = "frn", by.y = "frn")

oh_graph <- graph_from_data_frame(rel[,c("from", "to")], directed = FALSE, vertices = frn)

draw_me_a_graph <- function(x, ...) {
  threejs::graphjs(x,
          vertex.label = V(x)$provider_name, 
          vertex.color = rep(2, vcount(x)),
          vertex.size = .5, 
          edge.color = "black",
          edge.width = 2, ...)
}

sd = SharedData$new(data.frame(provider_name = V(oh_graph)$provider_name))
bscols(
  draw_me_a_graph(oh_graph, brush=TRUE, crosstalk=sd, width=550),
  datatable(sd, rownames=FALSE, options = list(dom='tp'), width=350)
)

```


:::

## Discussions

- Once data as code is in place we can focus on business logic 

- Place of business logic in primary data?

- Opinion: if something related to buiseness logic is needed it can be added 

## Summary

(Primary) data is only useful if you can **effectively** use it.

- Data as code: 

  * Providing data is not enough: need those extra "team members" to guide you 

  * Metadata is hard: data as code help with that!

  * Enhance reproducibility (accountability with a fake noze) 

- Easier to **capitalize/build** on it: generating less tech debt  

## Contacts

Website: [https://ruralinnovation.us](https://ruralinnovation.us)


[LinkedIn](https://www.linkedin.com/company/11099658) | [Twitter](https://twitter.com/Ruralinno) | [Facebook](https://www.facebook.com/RuralInno/) | [Instagram](https://www.instagram.com/ruralinno/) | [YouTube](https://www.youtube.com/channel/UCyqbtSrv4Nad9vVv4dQptcA) 
